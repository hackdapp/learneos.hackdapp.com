# 合约间交互

本小节主要介绍如何在当前合约中，对第三方合约数据进行查询或更新操作。

比如：在交易所合约中，查询某个帐户内的余额信息；在搓合成功后，如何及时更新用户帐户的余额信息等，而在这一过程中，统统需要与第三方合约进行数据交互工作。

----
**什么是合约间交互呢？** 其实就在合约中完成对第三方合约进行数据查询、添加、修改、删除操作。

在前面章节曾经介绍过，使用multiindex可以对合约数据表进行添加、修改、删除、查询等操作。那么针对第三方合约的操作，是否也可以直接使用multiindex进行操作呢？

**答案是**：查询可以，但数据更新那是不允许的。

那么接下来，我将会从如何对第三方合约查询、数据更新两方面进行分别讲解：

## 1. 如何在当前合约中查询第三方合约数据呢？

对第三方合约表数据进行查询，其实和查询本合约数据使用方式都是一样的。只不过在构建具体的索引实例时，所需要传入的参数有所不同。

因为在实例化索引时，需要传入两个参数：
- code 表所归属的用户，也就是要查询的合约帐户
- scope 数据存储维度，该值往往根据实际场景选择具体的变量或常量
所以，我们在查询第三方合约数据的时候，一定要搞清楚对方的合约名及数据存储维度；其次，需要了解所查询表的数据结构。对于数据结构，可以直接通过区块链浏览器（[Bloks.io | Fastest EOS Block Explorer and Wallet | EOS Cafe & HKEOS](https://bloks.io/)）查询对方合约的abi来获取。

🌰️：**在当前合约中查询某个帐户eos余额**

1. 定位所要查询的第三方合约  
	众所周知，eos币对应的是eosio.token合约。
2. 查询第三方合约表及数据结构  
	在明确了要查询的合约帐户后，我们就可以通过区块链浏览器查询对方合约具体ABI信息。那么在ABI信息中，就可以找到该合约中所有的表数据结构定义以及方法说明等信息。另外，eosio.token是公开合约，我们也可以直接从官方github中找到具体的源码实现。  

	比如：通过[https://bloks.io/account/eosio.token](https://bloks.io/account/eosio.token)查询ABI信息  
	![](http://cdn.hackdapp.com/2019-04-20-005450.jpg)， account为具体的用户余额数据结构；而accounts为具体的用户余额索引器定义。
3. 定义数据结构  
	根据对方合约的ABI信息，在当前合约中定义对应的数据结构及索引器
		//余额表定义
		struct account {
		    asset    balance;

		    uint64_t primary_key()const { return balance.symbol.name(); }
		};

		//索引器定义
		typedef eosio::multi_index<N(account), account> accounts;

4. 实例化索引及查询数据  
	因为eosio.token中帐户余额是基于帐户维度进行数据存储的，所以实例化时需要传入具体要查询的帐户名称
  ```
    asset token::get_balance( name owner, symbol_code sym )const
		{
		    accounts accountstable( _self, owner );
		    const auto& ac = accountstable.get( sym );
		    return ac.balance;
		}
  ```
	以上示例方法便是查询某个帐户某个币种的余额信息。

**推荐** ：因为eosio.token合约为公开合约，所以当我们需要查询eos余额信息时，可以直接在自己的合约中引入eosio.token.hpp来直接调用查询帐户余额方法。假如所要查询的合约非公开合约，那么则需要按前面介绍的方式进行自定义实现。

## 2. 如何在当前合约中操作第三方合约数据呢？

当我们需要对第三方合约进行数据更新操作时, 合约提供了两种调用方式：
- Inline Action  
	该调用方式类似于常规web项目开发过程的事务操作。如果在调用方法过程中出现任何例外，都将导致整个流程的回退，保证整个业务数据的原子性操作。  
	比如：当用户给交易所帐户转帐成功后，才更新交易所合约中充值帐户的余额信息。
- Deferred Action  
	该调用方式为异步调用方式。异步调用方法运行过程中存在任何例外错误，并不会对其主流程方法造成影响。该调用方式在合约实现中主要体现为延迟指定时间段后再执行，类似于cron定时调度。  
	**那么适用于什么业务场景呢？** EOS链要求合约方法执行时间不可超过30ms，那么很可能一些复杂的方法无法执行完毕，所以我们可选择将一些业务方法设计成异步方式，假如这些业务方法运行失败，那么也可以通过后续重新调用来进行数据修复。  

具体的使用方式，可直接阅读[4.4 同步与异步调用合约方法 - EOS完全开发指南\_v1.0](http://learneos.hackdapp.com/#/contracts/inline_deferred_actions)进行了解。  

除此之外，我们其实也可以通过异步或同步方式对**本合约中的方法**进行调用。

----
通过本章节的学习，我们学会了在合约中对第三方合约的数据查询及业务调用操作。
